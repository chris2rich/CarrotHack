package me.hero.onepop.onepopclient.hacks.exploit;

import java.util.Iterator;
import java.util.function.Predicate;
import me.hero.onepop.onepopclient.event.events.OnePopEventBlock;
import me.hero.onepop.onepopclient.event.events.OnePopEventPacket;
import me.hero.onepop.onepopclient.guiscreen.settings.OnePopSetting;
import me.hero.onepop.onepopclient.hacks.OnePopCategory;
import me.hero.onepop.onepopclient.hacks.OnePopHack;
import me.hero.onepop.onepopclient.util.OnePopTimer;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.block.Block;
import net.minecraft.block.state.IBlockState;
import net.minecraft.entity.Entity;
import net.minecraft.entity.item.EntityEnderCrystal;
import net.minecraft.init.Blocks;
import net.minecraft.network.play.client.CPacketAnimation;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketPlayerDigging.Action;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.util.math.BlockPos;

public class OnePopSpeedmine extends OnePopHack {
   OnePopSetting mode = this.create("Mode", "SpeedmineMode", "Normal", this.combobox(new String[]{"Normal", "Packet", "Damage", "Instant"}));
   OnePopSetting damage = this.create("Damage Ammount", "SpeedmineDamagaeAmmount", 0.7D, 0.0D, 1.0D);
   OnePopSetting reset = this.create("Reset", "SpeedmineReset", true);
   OnePopSetting no_break_anim = this.create("No Break Anim", "SpeedMineBreakAnim", false);
   OnePopSetting no_delay = this.create("No Delay", "SpeedmineNoDelay", false);
   OnePopSetting no_swing = this.create("No Swing", "SpeedmineNoSwing", false);
   OnePopSetting allow = this.create("MultiTask", "SpeedmineMultiTask", false);
   OnePopSetting double_break = this.create("Double Break", "SpeedmineDoubleBreak", false);
   private final OnePopTimer timer = new OnePopTimer();
   private IBlockState current_block_state = null;
   private BlockPos current_pos = null;
   private BlockPos last_pos = null;
   private EnumFacing last_facing = null;
   private boolean is_mining = false;
   @EventHandler
   private Listener<OnePopEventPacket.SendPacket> send_listener = new Listener((event) -> {
      if (this.no_swing.get_value(true) && event.get_packet() instanceof CPacketAnimation) {
         event.cancel();
      }

      if (this.no_break_anim.get_value(true) && event.get_packet() instanceof CPacketPlayerDigging) {
         CPacketPlayerDigging p = (CPacketPlayerDigging)event.get_packet();

         try {
            Iterator var3 = mc.field_71441_e.func_72839_b((Entity)null, new AxisAlignedBB(p.func_179715_a())).iterator();

            while(var3.hasNext()) {
               Entity entity = (Entity)var3.next();
               if (entity instanceof EntityEnderCrystal) {
                  this.show_anim();
                  return;
               }
            }
         } catch (Exception var5) {
         }

         if (p.func_180762_c().equals(Action.START_DESTROY_BLOCK)) {
            this.show_anim(true, p.func_179715_a(), p.func_179714_b());
         }

         if (p.func_180762_c().equals(Action.STOP_DESTROY_BLOCK)) {
            this.show_anim();
         }
      }

   }, new Predicate[0]);
   @EventHandler
   private Listener<OnePopEventBlock> block_event = new Listener((event) -> {
      if (event.get_stage() == 3 && this.reset.get_value(true) && mc.field_71442_b.field_78770_f > 0.1F) {
         mc.field_71442_b.field_78778_j = true;
      }

      if (event.get_stage() == 4 && !this.mode.in("Normal")) {
         if (canBreak(event.pos)) {
            if (this.reset.get_value(true)) {
               mc.field_71442_b.field_78778_j = false;
            }

            if (this.mode.in("Packet")) {
               if (this.current_pos == null) {
                  this.current_pos = event.pos;
                  this.current_block_state = mc.field_71441_e.func_180495_p(this.current_pos);
                  this.timer.reset();
               }

               mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.START_DESTROY_BLOCK, event.pos, event.facing));
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
               event.cancel();
            }

            if (this.mode.in("Damage") && mc.field_71442_b.field_78770_f >= (float)this.damage.get_value(1)) {
               mc.field_71442_b.field_78770_f = 1.0F;
            }

            if (this.mode.in("Instant")) {
               mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.START_DESTROY_BLOCK, event.pos, event.facing));
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
               mc.field_71442_b.func_187103_a(event.pos);
               mc.field_71441_e.func_175698_g(event.pos);
            }
         }

         if (this.double_break.get_value(true)) {
            BlockPos above = event.pos.func_177984_a();
            if (canBreak(above) && mc.field_71439_g.func_70011_f((double)above.func_177958_n(), (double)above.func_177956_o(), (double)above.func_177952_p()) <= 5.0D) {
               mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.START_DESTROY_BLOCK, above, event.facing));
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.STOP_DESTROY_BLOCK, above, event.facing));
               mc.field_71442_b.func_187103_a(above);
               mc.field_71441_e.func_175698_g(above);
            }
         }
      }

   }, new Predicate[0]);

   public OnePopSpeedmine() {
      super(OnePopCategory.ONEPOP_EXPLOIT);
      this.name = "Speed Mine";
      this.tag = "SpeedMine";
      this.description = "mine faster";
   }

   public void update() {
      if (this.current_pos != null && (!mc.field_71441_e.func_180495_p(this.current_pos).equals(this.current_block_state) || mc.field_71441_e.func_180495_p(this.current_pos).func_177230_c() == Blocks.field_150350_a)) {
         this.current_pos = null;
         this.current_block_state = null;
      }

      if (this.no_delay.get_value(true)) {
         mc.field_71442_b.field_78781_i = 0;
      }

      if (this.is_mining && this.last_pos != null && this.last_facing != null && this.no_break_anim.get_value(true)) {
         mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.ABORT_DESTROY_BLOCK, this.last_pos, this.last_facing));
      }

      if (this.reset.get_value(true) && mc.field_71474_y.field_74313_G.func_151470_d() && !this.allow.get_value(true)) {
         mc.field_71442_b.field_78778_j = false;
      }

   }

   public void show_anim(boolean is_mining, BlockPos last_pos, EnumFacing last_facing) {
      this.is_mining = is_mining;
      this.last_pos = last_pos;
      this.last_facing = last_facing;
   }

   public void show_anim() {
      this.show_anim(false, (BlockPos)null, (EnumFacing)null);
   }

   public String array_detail() {
      return this.mode.get_current_value();
   }

   public static boolean canBreak(BlockPos pos) {
      IBlockState blockState = mc.field_71441_e.func_180495_p(pos);
      Block block = blockState.func_177230_c();
      return block.func_176195_g(blockState, mc.field_71441_e, pos) != -1.0F;
   }
}
